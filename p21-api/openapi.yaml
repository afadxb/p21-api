openapi: 3.0.3
info:
  title: P21 API
  version: 1.0.0
servers:
  - url: http://localhost:3000
paths:
  /v1/ap/suppliers:
    get:
      summary: List AP suppliers
      description: |
        Returns a paginated list of suppliers from P21. Results can be filtered by
        company and by the most recent change to either the vendor or its payment terms.
        Implemented in `routes/v1/ap/suppliers.js`.
      parameters:
        - in: query
          name: updated_since
          schema:
            type: string
            format: date-time
          description: >-
            Optional ISO 8601 timestamp. When supplied, only suppliers whose vendor or
            payment terms were modified on or after this timestamp are returned.
        - in: query
          name: company
          schema:
            type: string
          description: Filter to a specific P21 company id.
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Results page number (1-indexed).
        - in: query
          name: page_size
          schema:
            type: integer
            minimum: 1
            maximum: 2000
            default: 500
          description: Number of records to include per page (max 2000).
      responses:
        '200':
          description: Supplier list with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SupplierListResponse'
        '400':
          description: Invalid query parameter supplied

  /v1/ap/paymentterms:
    get:
      summary: List AP payment terms
      description: |
        Returns a paginated list of payment terms from P21. Results can be filtered by
        the last modification timestamp. Implemented in `routes/v1/ap/paymentterms.js`.
      parameters:
        - in: query
          name: updated_since
          schema:
            type: string
            format: date-time
          description: >-
            Optional ISO 8601 timestamp. When supplied, only payment terms modified on
            or after this timestamp are returned.
        - in: query
          name: company
          schema:
            type: string
          description: Optional company identifier used to build composite ids in the response.
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Results page number (1-indexed).
        - in: query
          name: page_size
          schema:
            type: integer
            minimum: 1
            maximum: 2000
            default: 500
          description: Number of records to include per page (max 2000).
      responses:
        '200':
          description: Payment term list with pagination metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentTermListResponse'
        '400':
          description: Invalid query parameter supplied

  /inventory:
    get:
      summary: List inventory items
      description: |
        Returns a paginated list of inventory records from the P21 database.
        The logic for this endpoint lives in `routes/inventory.js` and supports
        optional paging, sorting, and filtering of inactive items.
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
          description: Maximum number of records to return (default `100`).
        - in: query
          name: paging
          schema:
            type: boolean
          description: When `true`, enables SQL paging.
        - in: query
          name: page
          schema:
            type: integer
          description: Page number when `paging=true`.
        - in: query
          name: order
          schema:
            type: string
            enum: [asc, desc]
          description: Sort order for the `item_id` column.
        - in: query
          name: inactive
          schema:
            type: boolean
          description: Include inactive items (`true` or `false`).
      responses:
        '200':
          description: Inventory list with paging metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InventoryListResponse'
  /inventory/{item_id}:
    get:
      summary: Get item by id
      description: |
        Retrieves a single inventory record. Implemented in
        `routes/inventory.js`.
      parameters:
        - in: path
          name: item_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Item details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemDetail'
        '404':
          description: Item not found
  /orders:

    post:
      summary: Store order payload
      description: |
        Receives a sales order payload and stores it in the `orders_received`
        table for later CSV generation.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                [customer_id, company_id, sales_location_id, taker, order_ref, approved, ship_to_id, contract_number, lines]
              properties:
                customer_id:
                  type: string
                company_id:
                  type: string
                sales_location_id:
                  type: string
                taker:
                  type: string
                order_ref:
                  type: string
                approved:
                  type: string
                ship_to_id:
                  type: string
                contract_number:
                  type: string
                notes:
                  type: string
                lines:
                  type: array
                  items:
                    type: object
                    required: [item_id, qty]
                    properties:
                      item_id:
                        type: string
                      qty:
                        type: integer
                      notes:
                        type: string
      responses:
        '200':
          description: Record identifier returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderReceivedResponse'

  /orders/export/{id}:
    post:
      summary: Generate CSV for stored order
      description: |
        Reads the order payload from the `orders_received` table and generates
        the CSV files. Results mirror the old `/orders` endpoint.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: CSV file locations and import set number returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderExportResponse'

  /orders/{order_id}:
    get:
      summary: Get sales order status
      description: |
        Retrieves a sales order header and its lines from P21. The `order_id`
        can be either the numeric `order_no` or the `order_ref` associated with
        the order. Each record is augmented with a `status` field derived from
        various flag columns. Implemented in `routes/orders.js`.
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Sales order header and lines returned with status fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SalesOrderResponse'
        '404':
          description: Order not found

components:
  schemas:
    InventorySummary:
      type: object
      properties:
        item_id:
          type: string
        item_desc:
          type: string
    InventoryListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/InventorySummary'
        totalCount:
          type: integer
        page:
          type: integer
        totalPages:
          type: integer
    SupplierTerms:
      type: object
      properties:
        id:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        discountPercent:
          type: number
          nullable: true
        discountDays:
          type: integer
          nullable: true
        netDays:
          type: integer
          nullable: true
    Supplier:
      type: object
      properties:
        erpSourceId:
          type: string
          nullable: true
        externalSystemId:
          type: string
          nullable: true
        isActive:
          type: boolean
        companyId:
          type: string
          nullable: true
        currencyCode:
          type: string
          nullable: true
        name:
          type: string
          nullable: true
        paymentTerm:
          type: string
          nullable: true
        supplierId:
          type: string
          nullable: true
        ledgerDimension1:
          type: string
          nullable: true
        taxDimension1:
          type: string
          nullable: true
        clearance1Dimension1:
          type: string
          nullable: true
        taxIndicator1:
          type: string
          nullable: true
        taxIndicator2:
          type: string
          nullable: true
        streetAddress:
          type: string
          nullable: true
        city:
          type: string
          nullable: true
        zip:
          type: string
          nullable: true
        country:
          type: string
          nullable: true
        telephone:
          type: string
          nullable: true
        fax:
          type: string
          nullable: true
        homepage:
          type: string
          nullable: true
        emailAddress:
          type: string
          nullable: true
        state:
          type: string
          nullable: true
        isProcurable:
          type: boolean
        prepayment:
          type: boolean
        updatedAt:
          type: string
          format: date-time
          nullable: true
        terms:
          $ref: '#/components/schemas/SupplierTerms'
    SupplierListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Supplier'
        page:
          type: integer
        pageSize:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    PaymentTermStartDate:
      type: object
      properties:
        type:
          type: string
          enum: [InvoiceDate]
        numberOfMonths:
          type: integer
    PaymentTermLine:
      type: object
      properties:
        cashDiscountPercentage:
          type: number
        endOfMonth:
          type: boolean
        numberOfDays:
          type: integer
        numberOfMonths:
          type: integer
    PaymentTerm:
      type: object
      properties:
        erpSourceId:
          type: string
        externalSystemId:
          type: string
        isActive:
          type: boolean
        lines:
          type: array
          items:
            $ref: '#/components/schemas/PaymentTermLine'
        companyId:
          type: string
          nullable: true
        paymentTermId:
          type: string
        name:
          type: string
        description:
          type: string
        startDate:
          $ref: '#/components/schemas/PaymentTermStartDate'
          nullable: true
        updatedAt:
          type: string
          format: date-time
          nullable: true
    PaymentTermListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/PaymentTerm'
        page:
          type: integer
        pageSize:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer

    ItemDetail:
      type: object
      properties:
        item_id:
          type: string
        inv_mast_uid:
          type: integer
        item_desc:
          type: string
        delete_flag:
          type: string
        weight:
          type: number
        net_weight:
          type: number
        inactive:
          type: string
        default_sales_discount_group:
          type: string
        extended_desc:
          type: string
        keywords:
          type: string
        base_unit:
          type: string
        commodity_code:
          type: string
        length:
          type: number
        width:
          type: number
        height:
          type: number
    OrderExportResponse:
      type: object
      properties:
        message:
          type: string
        files:
          type: object
          properties:
            headerFile:
              type: string
            linesFile:
              type: string
        importSetNumber:
          type: string
    OrderReceivedResponse:
      type: object
      properties:
        message:
          type: string
        id:
          type: integer
    OrderHeader:
      type: object
      properties:
        order_no:
          type: integer
        customer_id:
          type: string
        order_date:
          type: string
          format: date-time
        ship2_name:
          type: string
        ship2_add1:
          type: string
        po_no:
          type: string
        job_price_hdr_uid:
          type: integer
        delete_flag:
          type: string
        completed:
          type: string
        company_id:
          type: string
        date_created:
          type: string
          format: date-time
        po_no_append:
          type: string
        location_id:
          type: string
        carrier_id:
          type: string
        address_id:
          type: string
        taker:
          type: string
        approved:
          type: string
        cancel_flag:
          type: string
        promise_date:
          type: string
          format: date-time
        ups_code:
          type: string
        expedite_date:
          type: string
          format: date-time
        validation_status:
          type: string
        status:
          type: string
        order_ref:
          type: string
    OrderLine:
      type: object
      properties:
        order_no:
          type: integer
        qty_ordered:
          type: number
        delete_flag:
          type: string
        line_no:
          type: integer
        complete:
          type: string
        disposition:
          type: string
        qty_allocated:
          type: number
        qty_on_pick_tickets:
          type: number
        qty_invoiced:
          type: number
        required_date:
          type: string
          format: date-time
        unit_size:
          type: number
        unit_quantity:
          type: number
        customer_part_number:
          type: string
        cancel_flag:
          type: string
        qty_canceled:
          type: number
        status:
          type: string
    SalesOrderResponse:
      type: object
      properties:
        header:
          $ref: '#/components/schemas/OrderHeader'
        lines:
          type: array
          items:
            $ref: '#/components/schemas/OrderLine'
